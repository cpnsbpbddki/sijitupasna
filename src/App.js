import React, { useState, useEffect, useMemo } from 'react';
import { 
  LayoutDashboard, FileText, UserCog, MapPin, Building, Users, Save, 
  Lock, Camera, Trash2, Plus, AlertTriangle, Sun, Moon, LogOut, 
  Menu, X, ShieldCheck, Activity, Database, TrendingUp, Signal, 
  KeyRound, ChevronRight, GraduationCap, Layers, Box, CheckCircle, 
  XCircle, Loader2, Edit, ExternalLink, RefreshCw, Bell, Megaphone,
  Landmark, Calculator, FileDown, FileSpreadsheet, Printer, User
} from 'lucide-react';
import jsPDF from 'jspdf';
import 'jspdf-autotable';

// --- MASUKAN URL BARU ANDA DISINI ---
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxEMu2n98ZPMihxXFS29ijcJHQx08sZnnpgAVnRFSSz3jbdcBvmjMgcCuIcvg04ZR0S6g/exec"; 

const App = () => {
  // STATE
  const [users, setUsers] = useState([]);
  const [reports, setReports] = useState([]);
  const [runningText, setRunningText] = useState("Selamat Datang di SIJITUPASNA");
  const [isSyncing, setIsSyncing] = useState(false);
  const [isLoadingInit, setIsLoadingInit] = useState(true);
  const [currentUser, setCurrentUser] = useState(null); 
  const [theme, setTheme] = useState('dark');
  const [currentView, setCurrentView] = useState('dashboard'); 
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [editData, setEditData] = useState(null);
  const [notification, setNotification] = useState({ show: false, message: '', type: 'success' });
  const [showPasswordModal, setShowPasswordModal] = useState(false);

  useEffect(() => {
    const savedUser = localStorage.getItem('sijitupasna_user');
    if (savedUser) { try { setCurrentUser(JSON.parse(savedUser)); } catch (e) { localStorage.removeItem('sijitupasna_user'); } }
    fetchInitData();
  }, []);

  const fetchInitData = () => {
    setIsLoadingInit(true);
    if(GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith("http")) {
        fetch(`${GOOGLE_SCRIPT_URL}?action=get_init_data`)
        .then(res => res.json())
        .then(data => { setUsers(data.users || []); if(data.notification) setRunningText(data.notification); setIsLoadingInit(false); })
        .catch(err => { console.error(err); setIsLoadingInit(false); });
    } else {
        setUsers([{ id: 1, username: 'admin', password: '123', role: 'admin', name: 'Admin Demo', assignedKelurahan: '' }]);
        setIsLoadingInit(false);
    }
  };

  const fetchReports = () => {
    setIsSyncing(true);
    if(GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith("http")) {
        fetch(`${GOOGLE_SCRIPT_URL}?action=get_reports&t=${Date.now()}`)
        .then(res => res.json())
        .then(data => { setReports(data); setIsSyncing(false); showToast("Data terupdate", 'success'); })
        .catch(err => { console.error(err); setIsSyncing(false); showToast("Gagal sync", 'error'); });
    } else { setTimeout(() => setIsSyncing(false), 1000); }
  };

  useEffect(() => { if (currentUser && currentView === 'dashboard') fetchReports(); }, [currentUser, currentView]);

  const showToast = (msg, type = 'success') => { setNotification({ show: true, message: msg, type }); setTimeout(() => setNotification({ show: false, message: '', type: 'success' }), 3000); };
  const handleLogin = (u) => { setCurrentUser(u); localStorage.setItem('sijitupasna_user', JSON.stringify(u)); showToast(`Halo, ${u.name}!`); };
  const handleLogout = () => { localStorage.removeItem('sijitupasna_user'); setCurrentUser(null); setCurrentView('dashboard'); };
  
  const handleUpdateRunningText = (newText) => {
    setRunningText(newText);
    if(GOOGLE_SCRIPT_URL) fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'update_notification', text: newText }) });
    showToast("Pengumuman disimpan!", "success");
  };

  const handleUpdateProfile = (newData) => {
    const updatedUser = { ...currentUser, ...newData };
    setCurrentUser(updatedUser);
    localStorage.setItem('sijitupasna_user', JSON.stringify(updatedUser));
    if(GOOGLE_SCRIPT_URL) {
        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'update_profile', username: currentUser.username, newName: newData.name, newPassword: newData.password }) });
    }
    showToast("Profil diperbarui!", "success");
  };

  const stats = useMemo(() => {
    const totalData = reports.length;
    const totalLoss = reports.reduce((acc, curr) => acc + (parseInt(curr.assets?.totalKerugian) || 0) + (parseInt(curr.building?.totalKerugianBangunan) || 0), 0);
    return { totalData, totalLoss };
  }, [reports]);

  const exportCSV = () => {
    if (reports.length === 0) return showToast("Data kosong", "error");
    let csvContent = "data:text/csv;charset=utf-8,Timestamp,Surveyor,Pemilik,Kelurahan,RT,RW,Legalitas,NJOP,Kerusakan,Luas(m2),Lantai,Kerugian Bangunan,Aset Terdampak,Kerugian Aset,Foto\n";
    reports.forEach(row => {
      const b = row.building || {};
      const clean = (t) => t ? `"${String(t).replace(/"/g, '""')}"` : "";
      csvContent += `${row.timestamp},${row.surveyor},${clean(row.survivor.nama)},${row.survivor.kelurahan},${row.survivor.rt},${row.survivor.rw},${b.legalitas},${b.njop},${b.kerusakan},${b.luas},${b.lantai},${b.totalKerugianBangunan},${clean(b.asetTerdampak)},${row.assets?.totalKerugian},${row.photos ? row.photos.replace(/\n/g,"|") : ""}\n`;
    });
    const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", "REKAP_JITUPASNA.csv"); document.body.appendChild(link); link.click();
  };

  const generatePDF = (data) => {
    try {
      const doc = new jsPDF();
      doc.setFillColor(234, 88, 12); doc.rect(0, 0, 210, 25, 'F');
      doc.setTextColor(255, 255, 255); doc.setFontSize(16); doc.text("LAPORAN E-JITUPASNA", 105, 12, null, null, "center");
      doc.setFontSize(10); doc.text("BPBD PROVINSI DKI JAKARTA", 105, 19, null, null, "center");
      doc.setTextColor(0, 0, 0); doc.setFontSize(11); doc.text(`PEMILIK: ${data.survivor.nama}`, 14, 35);
      doc.setFontSize(10); doc.text(`Lokasi: Kel. ${data.survivor.kelurahan} RT ${data.survivor.rt}/${data.survivor.rw}`, 14, 41);
      const b = data.building || {}; const a = data.assets || {};
      const tableRows = [['Surveyor', data.surveyor], ['Koordinat', `${data.survivor.lat}, ${data.survivor.lng}`], ['Alamat', data.survivor.alamat || '-'], [{ content: 'DATA BANGUNAN', colSpan: 2, styles: { fillColor: [240, 240, 240], fontStyle: 'bold' } }], ['Legalitas', b.legalitas], ['Dimensi', `${b.panjang}x${b.lebar}m (${b.luas} mÂ²)`], ['Kerusakan', `${b.kerusakan} (${b.persentase}%)`], ['Aset Terdampak', b.asetTerdampak], [{ content: 'VALUASI (Rp)', colSpan: 2, styles: { fillColor: [240, 240, 240], fontStyle: 'bold' } }], ['NJOP', parseInt(b.njop||0).toLocaleString()], ['Rugi Bangunan', parseInt(b.totalKerugianBangunan||0).toLocaleString()], ['Rugi Aset', parseInt(a.totalKerugian||0).toLocaleString()], [{ content: `TOTAL: Rp ${(parseInt(b.totalKerugianBangunan||0)+parseInt(a.totalKerugian||0)).toLocaleString()}`, colSpan: 2, styles: { fillColor: [234, 88, 12], textColor: 255, fontStyle: 'bold' } }]];
      doc.autoTable({ startY: 55, head: [['Item', 'Detail']], body: tableRows });
      if (data.photos) { const links = data.photos.split('\n'); doc.text("Foto:", 14, doc.lastAutoTable.finalY + 10); links.forEach((l, i) => doc.textWithLink(`- Foto ${i+1}`, 14, doc.lastAutoTable.finalY + 16 + (i*6), { url: l })); }
      doc.save(`Laporan_${data.survivor.nama}.pdf`);
    } catch (e) { showToast("Gagal PDF", "error"); }
  };

  if (!currentUser) return <LoginScreen users={users} loading={isLoadingInit} onLogin={handleLogin} onFail={() => showToast('Login Gagal.', 'error')} />;

  return (
    <div className={`flex h-screen overflow-hidden transition-colors duration-500 font-sans ${theme === 'dark' ? 'bg-[#0b1120] text-gray-100' : 'bg-slate-50 text-slate-800'}`}>
      <aside className={`fixed inset-y-0 left-0 z-50 w-64 transform transition-transform duration-300 ease-in-out ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 flex flex-col border-r backdrop-blur-xl ${theme === 'dark' ? 'bg-[#0f172a]/95 border-white/10' : 'bg-white/95 border-slate-200'}`}>
        <div className="h-16 flex items-center gap-3 px-6 border-b border-white/10"><ShieldCheck className="text-orange-600" size={24} /><div><h1 className="font-black text-lg">SIJITUPASNA</h1><p className="text-[9px] opacity-60">BPBD DKI JAKARTA</p></div><button onClick={() => setMobileMenuOpen(false)} className="md:hidden ml-auto"><X size={20}/></button></div>
        <nav className="flex-1 p-4 space-y-1 overflow-y-auto"><NavButton icon={LayoutDashboard} label="Dashboard" active={currentView === 'dashboard'} onClick={() => { setCurrentView('dashboard'); setMobileMenuOpen(false); }} isDark={theme==='dark'} /><NavButton icon={FileText} label="Input Data" active={currentView === 'input'} onClick={() => { setEditData(null); setCurrentView('input'); setMobileMenuOpen(false); }} isDark={theme==='dark'} /><NavButton icon={User} label="Profil Saya" active={currentView === 'profile'} onClick={() => { setCurrentView('profile'); setMobileMenuOpen(false); }} isDark={theme==='dark'} />{currentUser.role === 'admin' && (<><div className="my-4 border-t border-white/10 opacity-50"></div><p className="px-4 text-[10px] font-bold uppercase opacity-50 mb-2">Admin</p><NavButton icon={UserCog} label="User Management" active={currentView === 'users'} onClick={() => { setCurrentView('users'); setMobileMenuOpen(false); }} isDark={theme==='dark'} /><NavButton icon={Megaphone} label="Set Pengumuman" active={currentView === 'notification'} onClick={() => { setCurrentView('notification'); setMobileMenuOpen(false); }} isDark={theme==='dark'} /></>)}</nav>
        <div className={`p-4 border-t ${theme === 'dark' ? 'bg-black/20' : 'bg-slate-100'}`}><div className="mb-2 font-bold text-sm truncate">{currentUser.name}</div><button onClick={handleLogout} className="w-full p-2 bg-red-500/10 text-red-500 rounded text-xs hover:bg-red-500 hover:text-white transition flex items-center justify-center gap-2"><LogOut size={14}/> Logout</button></div>
      </aside>
      <div className="flex-1 flex flex-col h-screen overflow-hidden relative">
        <div className="h-8 bg-blue-900 flex items-center overflow-hidden relative z-20 shadow-md"><div className="bg-red-600 h-full px-3 flex items-center justify-center z-10 font-bold text-[10px] text-white tracking-widest shadow-lg">INFO <Bell size={10} className="ml-1 animate-bounce"/></div><div className="whitespace-nowrap animate-marquee pl-4 text-xs font-medium text-white flex items-center">{runningText}</div></div>
        <div className="md:hidden h-14 flex items-center px-4 border-b border-white/10 backdrop-blur-md sticky top-0 z-10 justify-between"><div className="flex items-center gap-2"><button onClick={() => setMobileMenuOpen(true)} className="p-2 -ml-2"><Menu/></button><span className="font-bold text-sm">SIJITUPASNA</span></div></div>
        <main className="flex-1 overflow-y-auto p-4 md:p-8 scrollbar-hide">
          <div className="max-w-6xl mx-auto">
            {currentView === 'dashboard' && <DashboardView stats={stats} reports={reports} isSyncing={isSyncing} onSync={fetchReports} isDark={theme === 'dark'} currentUser={currentUser} onEdit={(row) => { setEditData(row); setCurrentView('input'); }} onExportCSV={exportCSV} onPrintPDF={generatePDF} />}
            {currentView === 'input' && <InputForm user={currentUser} isDark={theme === 'dark'} onSuccess={() => { setEditData(null); fetchReports(); setCurrentView('dashboard'); showToast(editData ? "Update Sukses" : "Data Tersimpan", 'success'); }} googleScriptUrl={GOOGLE_SCRIPT_URL} editData={editData} onCancelEdit={() => { setEditData(null); setCurrentView('dashboard'); }} />}
            {currentView === 'users' && currentUser.role === 'admin' && <UserManagement users={users} setUsers={setUsers} isDark={theme === 'dark'} googleScriptUrl={GOOGLE_SCRIPT_URL} showToast={showToast} />}
            {currentView === 'notification' && currentUser.role === 'admin' && <NotificationSetting currentText={runningText} onSave={handleUpdateRunningText} isDark={theme === 'dark'} />}
            {currentView === 'profile' && <UserProfile user={currentUser} onUpdate={handleUpdateProfile} isDark={theme === 'dark'} />}
          </div>
        </main>
      </div>
      <NotificationToast notification={notification} />
      <style>{`@keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } } .animate-marquee { animation: marquee 20s linear infinite; }`}</style>
    </div>
  );
};

const InputForm = ({ user, isDark, onSuccess, googleScriptUrl, editData, onCancelEdit }) => {
  const [activeTab, setActiveTab] = useState('A'); const [isSubmitting, setIsSubmitting] = useState(false); const [locked, setLocked] = useState(false); const [showConfirm, setShowConfirm] = useState(false);
  const [survivor, setSurvivor] = useState({ nama: '', alamat: '', kelurahan: '', rt: '', rw: '', lat: '', lng: '' });
  const [building, setBuilding] = useState({ panjang: '', lebar: '', luas: 0, lantai: '', kerusakan: 'sedang', persentase: '', asetTerdampak: '', foto: [], keterangan: '', legalitas: 'SHM', njop: '', totalKerugianBangunan: 0 });
  const [families, setFamilies] = useState([]); const [assetLoss, setAssetLoss] = useState(''); const [notes, setNotes] = useState('');
  
  useEffect(() => { if (editData) { setSurvivor(editData.survivor || { nama: '', alamat: '', kelurahan: '', rt: '', rw: '', lat: '', lng: '' }); setBuilding({ legalitas: 'SHM', njop: '', totalKerugianBangunan: 0, ...(editData.building||{}), foto: [] }); setFamilies(editData.families || []); setAssetLoss(editData.assets?.totalKerugian || ''); setLocked(true); } else if (user?.assignedKelurahan) { setSurvivor(prev => ({ ...prev, kelurahan: user.assignedKelurahan })); } }, [editData, user]);
  useEffect(() => { const p=parseFloat(building.panjang), l=parseFloat(building.lebar); setBuilding(prev=>({...prev, luas: (!isNaN(p)&&!isNaN(l)?(p*l).toFixed(2):0)})); }, [building.panjang, building.lebar]);
  useEffect(() => { const luas = parseFloat(building.luas)||0; const njop = parseFloat(building.njop)||0; setBuilding(prev => ({ ...prev, totalKerugianBangunan: luas * njop })); }, [building.luas, building.njop]);
  
  const handleGetLocation = () => { if(navigator.geolocation) navigator.geolocation.getCurrentPosition((pos) => { setSurvivor(prev => ({ ...prev, lat: pos.coords.latitude.toFixed(6), lng: pos.coords.longitude.toFixed(6) })); setLocked(true); }, () => alert("Gagal GPS.")); };
  const addFamily = () => setFamilies([...families, { id: Date.now(), nama: '', kerja: '', jmlAnggota: '', jmlSekolah: '', gaji: '', hari: '', rugi: 0 }]);
  const updateFamily = (id, field, val) => { setFamilies(families.map(f => { if(f.id === id) { const up = { ...f, [field]: val }; if(field === 'gaji' || field === 'hari') up.rugi = (parseFloat(up.gaji)||0) * (parseFloat(up.hari)||0); return up; } return f; })); };
  const handleFileChange = async (e) => { const files = Array.from(e.target.files); const base64Files = await Promise.all(files.map(file => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve({ name: file.name, type: file.type, data: reader.result.split(',')[1] }); reader.onerror = reject; }))); setBuilding(prev => ({ ...prev, foto: [...prev.foto, ...base64Files] })); };
  const handleConfirmSubmit = () => { setShowConfirm(false); setIsSubmitting(true); const action = editData ? 'edit_report' : 'submit_report'; const payload = { action, originalTimestamp: editData?.timestamp, timestamp: editData?.timestamp || new Date().toISOString(), surveyor: user.username, survivor, building, families, assets: { totalKerugian: assetLoss, notes }, photos: building.foto }; if (googleScriptUrl) fetch(googleScriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) }).then(() => { setIsSubmitting(false); onSuccess(); }).catch(err => { console.error(err); setIsSubmitting(false); }); };
  const inputClass = `w-full p-3 rounded-lg border outline-none transition ${isDark ? 'bg-black/20 border-white/10 focus:border-blue-500 text-white' : 'bg-slate-50 border-slate-300 focus:border-blue-500 text-slate-900'}`;
  
  return (
    <div className={`max-w-4xl mx-auto rounded-2xl border backdrop-blur-xl overflow-hidden ${isDark ? 'bg-slate-900/50 border-white/10' : 'bg-white border-slate-200 shadow-xl'}`}>
      <div className={`p-6 border-b flex justify-between items-center ${isDark ? 'bg-blue-900/20 border-white/10' : 'bg-blue-50 border-blue-100'}`}><div><h2 className="text-xl font-black flex items-center gap-2"><FileText className="text-blue-500"/> {editData ? 'EDIT DATA' : 'INPUT DATA'}</h2><p className="text-xs opacity-60">Wilayah: {user.assignedKelurahan || 'Global'}</p></div>{editData && <button onClick={onCancelEdit} className="text-xs bg-red-500/20 text-red-500 px-3 py-1.5 rounded-lg border border-red-500/30">Batal Edit</button>}</div>
      <div className="flex border-b border-white/10">{['A. Identitas', 'B. Bangunan', 'C. Detail'].map((t, i) => (<button key={i} onClick={() => setActiveTab(t.charAt(0))} className={`flex-1 py-4 text-sm font-bold border-b-2 transition ${activeTab === t.charAt(0) ? 'border-blue-500 text-blue-500 bg-blue-500/5' : 'border-transparent opacity-50'}`}>{t}</button>))}</div>
      <div className="p-6 space-y-6">
        {activeTab === 'A' && (<div className="space-y-4 animate-slideIn"><div className={`p-4 rounded-xl border flex justify-between items-center ${isDark ? 'bg-blue-500/10 border-blue-500/30' : 'bg-blue-50 border-blue-200'}`}><div><h3 className="font-bold text-sm">GEO-TAGGING</h3><p className="text-xs opacity-60">{locked ? `GPS: ${survivor.lat}, ${survivor.lng}` : 'Kunci lokasi.'}</p></div><button type="button" onClick={handleGetLocation} className={`px-4 py-2 rounded-lg font-bold text-xs ${locked ? 'bg-emerald-500 text-white' : 'bg-blue-500 text-white animate-pulse'}`}>{locked ? 'TERKUNCI' : 'AMBIL GPS'}</button></div><div><label className="text-xs font-bold opacity-60 mb-1 block">Nama Pemilik</label><input required value={survivor.nama} onChange={e => setSurvivor({...survivor, nama: e.target.value})} className={inputClass} /></div><div><label className="text-xs font-bold opacity-60 mb-1 block">Kelurahan</label><input required value={survivor.kelurahan} onChange={e => setSurvivor({...survivor, kelurahan: e.target.value.toUpperCase()})} className={`${inputClass} uppercase`} readOnly={!!user.assignedKelurahan && !editData} placeholder={user.assignedKelurahan ? "TERKUNCI" : ""} /></div><div className="grid grid-cols-2 gap-4"><input placeholder="RT" type="number" value={survivor.rt} onChange={e => setSurvivor({...survivor, rt: e.target.value})} className={inputClass} /><input placeholder="RW" type="number" value={survivor.rw} onChange={e => setSurvivor({...survivor, rw: e.target.value})} className={inputClass} /></div><div><label className="text-xs font-bold opacity-60 mb-1 block">Alamat Lengkap</label><textarea value={survivor.alamat} onChange={e => setSurvivor({...survivor, alamat: e.target.value})} className={inputClass} rows="2"></textarea></div></div>)}
        {activeTab === 'B' && (<div className="space-y-4 animate-slideIn"><div className="grid grid-cols-3 gap-4"><div><label className="text-xs font-bold opacity-60 mb-1 block">Panjang</label><input type="number" value={building.panjang} onChange={e => setBuilding({...building, panjang: e.target.value})} className={inputClass} /></div><div><label className="text-xs font-bold opacity-60 mb-1 block">Lebar</label><input type="number" value={building.lebar} onChange={e => setBuilding({...building, lebar: e.target.value})} className={inputClass} /></div><div><label className="text-xs font-bold opacity-60 mb-1 block">Luas</label><input readOnly value={building.luas} className={`${inputClass} opacity-60 cursor-not-allowed`} /></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="text-xs font-bold opacity-60 mb-1 block">Legalitas</label><select value={building.legalitas} onChange={e => setBuilding({...building, legalitas: e.target.value})} className={inputClass}>{['SHM', 'SHGB', 'SHGU', 'SHP', 'HPL', 'SHMSRS', 'GIRIK', 'Surat Lainnya'].map(opt => <option key={opt} value={opt}>{opt}</option>)}</select></div><div><label className="text-xs font-bold opacity-60 mb-1 block">Jml Lantai</label><input type="number" value={building.lantai} onChange={e => setBuilding({...building, lantai: e.target.value})} className={inputClass} /></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-orange-500/5 p-4 rounded-xl border border-orange-500/10"><div><label className="text-xs font-bold text-orange-500 mb-1 block">Harga NJOP</label><input type="number" placeholder="Rp" value={building.njop} onChange={e => setBuilding({...building, njop: e.target.value})} className={inputClass} /></div><div><label className="text-xs font-bold text-orange-500 mb-1 block">Kerugian Bangunan</label><input readOnly value={parseFloat(building.totalKerugianBangunan||0).toLocaleString()} className={`${inputClass} cursor-not-allowed`} /></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="text-xs font-bold opacity-60 mb-1 block">Kondisi</label><select value={building.kerusakan} onChange={e => setBuilding({...building, kerusakan: e.target.value})} className={inputClass}><option value="baik">Rusak Ringan</option><option value="sedang">Rusak Sedang</option><option value="rusak">Rusak Berat</option></select></div><div><label className="text-xs font-bold opacity-60 mb-1 block">Persentase (%)</label><input type="number" max="100" value={building.persentase} onChange={e => setBuilding({...building, persentase: e.target.value})} className={inputClass} /></div></div><div><label className="text-xs font-bold opacity-60 mb-1 block">Aset Terdampak</label><textarea value={building.asetTerdampak} onChange={e => setBuilding({...building, asetTerdampak: e.target.value})} className={inputClass} rows="2"/></div><div><label className="text-xs font-bold opacity-60 mb-1 block">Foto</label><div className={`border-2 border-dashed rounded-xl p-6 text-center hover:border-blue-500 cursor-pointer ${isDark?'border-white/20':'border-slate-300'}`}><input type="file" multiple onChange={handleFileChange} className="hidden" id="fup"/><label htmlFor="fup"><Camera className="mx-auto mb-2 opacity-50" size={30}/><p className="text-xs font-bold">{editData ? 'Upload Foto Baru' : 'Klik Upload'}</p>{building.foto.length>0 && <p className="text-xs text-green-500 mt-1">{building.foto.length} Dipilih</p>}</label></div></div></div>)}
        {activeTab === 'C' && (<div className="space-y-4 animate-slideIn"><div className={`p-4 rounded-xl border ${isDark ? 'bg-white/5 border-white/10' : 'bg-slate-50 border-slate-200'}`}><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-blue-500 text-sm">KK TERDAMPAK</h3><button type="button" onClick={addFamily} className="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">+ Tambah</button></div>{families.map((f, idx) => (<div key={f.id} className="mb-4 pb-4 border-b border-white/10 last:border-0 relative"><button type="button" onClick={() => setFamilies(families.filter(x => x.id !== f.id))} className="absolute top-0 right-0 text-red-500"><Trash2 size={14}/></button><div className="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2"><input placeholder="Nama KK" value={f.nama} onChange={e => updateFamily(f.id, 'nama', e.target.value)} className={inputClass} /><input placeholder="Pekerjaan" value={f.kerja} onChange={e => updateFamily(f.id, 'kerja', e.target.value)} className={inputClass} /></div><div className="grid grid-cols-2 gap-2 mb-2"><input type="number" placeholder="Jml Anggota" value={f.jmlAnggota} onChange={e => updateFamily(f.id, 'jmlAnggota', e.target.value)} className={inputClass} /><input type="number" placeholder="Anak Sekolah" value={f.jmlSekolah} onChange={e => updateFamily(f.id, 'jmlSekolah', e.target.value)} className={inputClass} /></div><div className="grid grid-cols-3 gap-2"><input type="number" placeholder="Gaji" value={f.gaji} onChange={e => updateFamily(f.id, 'gaji', e.target.value)} className={inputClass} /><input type="number" placeholder="Hari" value={f.hari} onChange={e => updateFamily(f.id, 'hari', e.target.value)} className={inputClass} /><input readOnly value={f.rugi.toLocaleString()} className={`${inputClass} text-right`} /></div></div>))}</div><div><label className="text-xs font-bold opacity-60 mb-1 block">Total Kerugian Aset (Rp)</label><input type="number" value={assetLoss} onChange={e => setAssetLoss(e.target.value)} className={inputClass} /></div></div>)}
        <div className="pt-6 flex justify-between border-t border-white/10"><button type="button" onClick={() => setActiveTab(prev => prev === 'C' ? 'B' : 'A')} className={`text-xs font-bold opacity-60 hover:opacity-100 ${activeTab === 'A' ? 'hidden' : ''}`}>&larr; KEMBALI</button>{activeTab !== 'C' ? (<button type="button" onClick={() => setActiveTab(prev => prev === 'A' ? 'B' : 'C')} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold text-sm ml-auto">LANJUT &rarr;</button>) : (<button type="button" onClick={() => setShowConfirm(true)} disabled={isSubmitting} className={`bg-gradient-to-r from-blue-600 to-indigo-600 text-white w-full py-4 rounded-xl font-black shadow-lg flex items-center justify-center gap-2 ${isSubmitting ? 'opacity-50' : 'hover:scale-[1.01]'}`}>{isSubmitting ? 'MENYIMPAN...' : <><Save size={20}/> {editData ? 'UPDATE' : 'KIRIM'}</>}</button>)}</div>
      </div>
      <ConfirmationModal isOpen={showConfirm} onClose={() => setShowConfirm(false)} onConfirm={handleConfirmSubmit} isDark={isDark} />
    </div>
  );
};

// --- SUPPORTING COMPONENTS ---
const NavButton = ({ icon: Icon, label, active, onClick }) => <button onClick={onClick} className={`flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold transition-all ${active ? 'bg-gradient-to-r from-orange-600 to-red-600 text-white shadow-lg' : 'text-slate-400 hover:bg-white/5'}`}><Icon size={16}/> {label}</button>;
const NotificationToast = ({ notification }) => (!notification.show ? null : <div className={`fixed top-24 right-6 z-[100] flex items-center gap-3 px-6 py-4 rounded-xl shadow-2xl animate-bounce-in border backdrop-blur-md ${notification.type==='error'?'bg-red-900/90 border-red-500 text-white':'bg-emerald-900/90 border-emerald-500 text-white'}`}>{notification.type==='error'?<XCircle size={24}/>:<CheckCircle size={24}/>}<div><h4 className="font-bold text-sm">{notification.type==='error'?'Error':'Sukses'}</h4><p className="text-xs opacity-90">{notification.message}</p></div></div>);
const StatCard = ({ title, value, icon: Icon, color, isDark }) => <div className={`p-6 rounded-2xl border relative overflow-hidden ${isDark ? 'bg-slate-900/50 border-white/10' : 'bg-white border-slate-200 shadow-md'}`}><div className={`absolute -right-6 -top-6 w-24 h-24 bg-${color}-500/20 rounded-full blur-xl`}></div><div className="relative z-10"><p className="text-xs font-bold opacity-60 uppercase">{title}</p><h3 className="text-3xl font-black mt-2 tracking-tight">{value}</h3></div></div>;
const ConfirmationModal = ({ isOpen, onClose, onConfirm, isDark }) => (!isOpen ? null : <div className="fixed inset-0 z-[60] flex items-center justify-center p-4"><div className="absolute inset-0 bg-black/60 backdrop-blur-md" onClick={onClose}></div><div className={`relative w-full max-w-md p-6 rounded-3xl shadow-2xl border animate-bounce-in ${isDark ? 'bg-[#0f172a] border-white/20' : 'bg-white border-slate-200'}`}><div className="flex flex-col items-center text-center mb-6"><ShieldCheck size={32} className="text-orange-500 mb-2"/><h3 className="text-xl font-black">KONFIRMASI</h3><p className="text-sm opacity-60">Pastikan data valid.</p></div><div className="flex gap-3"><button onClick={onClose} className="flex-1 py-3 rounded-xl border opacity-60">BATAL</button><button onClick={onConfirm} className="flex-1 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold">YA, SIMPAN</button></div></div></div>);
const NotificationSetting = ({ currentText, onSave, isDark }) => { const [txt, setTxt] = useState(currentText); return (<div className={`p-6 rounded-2xl border ${isDark ? 'bg-slate-900 border-white/10' : 'bg-white'}`}><h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Megaphone className="text-orange-500"/> Atur Running Text</h3><textarea className={`w-full p-4 rounded-xl border outline-none mb-4 ${isDark?'bg-black/20 border-white/10':'bg-slate-50'}`} rows="3" value={txt} onChange={e=>setTxt(e.target.value)}></textarea><button onClick={() => onSave(txt)} className="bg-orange-600 text-white px-6 py-2 rounded-lg font-bold">Simpan Pengumuman</button></div>); };
const UserProfile = ({ user, onUpdate, isDark }) => { const [name, setName] = useState(user.name); const [pass, setPass] = useState(user.password); return (<div className={`max-w-md mx-auto p-8 rounded-3xl border shadow-2xl animate-slideIn ${isDark ? 'bg-slate-900/50 border-white/10' : 'bg-white border-slate-200'}`}><div className="flex flex-col items-center mb-8"><div className="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center text-3xl font-bold text-white mb-4 shadow-lg">{user.name.charAt(0)}</div><h2 className="text-2xl font-bold">Profil Saya</h2><p className="opacity-60 text-sm">@{user.username} | {user.assignedKelurahan || 'Global'}</p></div><div className="space-y-4"><div><label className="text-xs font-bold opacity-60 mb-1 block">Nama Lengkap</label><input className={`w-full p-3 rounded-xl border outline-none ${isDark?'bg-black/20 border-white/10':'bg-slate-50'}`} value={name} onChange={e=>setName(e.target.value)} /></div><div><label className="text-xs font-bold opacity-60 mb-1 block">Password Baru</label><input className={`w-full p-3 rounded-xl border outline-none ${isDark?'bg-black/20 border-white/10':'bg-slate-50'}`} value={pass} onChange={e=>setPass(e.target.value)} /></div><button onClick={() => onUpdate({ name, password: pass })} className="w-full py-3 mt-4 bg-blue-600 text-white rounded-xl font-bold shadow-lg">SIMPAN PERUBAHAN</button></div></div>); };
const DashboardView = ({ stats, reports, isSyncing, onSync, isDark, currentUser, onEdit, onExportCSV, onPrintPDF }) => (<div className="space-y-8 animate-fadeIn"><div className="grid grid-cols-1 md:grid-cols-3 gap-6"><StatCard title="Total Laporan" value={stats.totalData} icon={Database} color="blue" isDark={isDark} /><StatCard title="Total Kerugian" value={`Rp ${(stats.totalLoss/1000000).toFixed(0)} Jt`} icon={TrendingUp} color="orange" isDark={isDark} /><StatCard title="Status" value="Online" icon={Signal} color="emerald" isDark={isDark} /></div><div className={`rounded-2xl border overflow-hidden ${isDark ? 'bg-slate-900/40 border-white/10' : 'bg-white shadow-xl'}`}><div className="p-6 border-b border-white/10 flex justify-between items-center"><h3 className="font-bold text-lg">Input Terkini</h3><div className="flex gap-2"><button onClick={onSync} disabled={isSyncing} className={`flex items-center gap-2 text-xs bg-emerald-500/10 text-emerald-500 px-3 py-2 rounded-lg border border-emerald-500/20 font-bold ${isSyncing ? 'opacity-50' : ''}`}>{isSyncing ? <Loader2 size={14} className="animate-spin" /> : <RefreshCw size={14} />} Refresh</button>{currentUser.role === 'admin' && <button onClick={onExportCSV} className="flex items-center gap-2 text-xs bg-blue-500/10 text-blue-500 px-3 py-2 rounded-lg border border-blue-500/20 font-bold"><FileSpreadsheet size={14} /> Export CSV</button>}</div></div><div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className={`text-xs uppercase font-bold ${isDark ? 'bg-black/20 text-slate-400' : 'bg-slate-50 text-slate-600'}`}><tr><th className="px-6 py-4">Pemilik</th><th className="px-6 py-4">Lokasi</th><th className="px-6 py-4">Kerusakan</th><th className="px-6 py-4">Foto</th><th className="px-6 py-4">Aksi</th></tr></thead><tbody className="divide-y divide-white/5">{reports.map((row, idx) => (<tr key={idx} className={`transition ${isDark ? 'hover:bg-white/5' : 'hover:bg-slate-50'}`}><td className="px-6 py-4"><div className="font-bold">{row.survivor.nama}</div><div className="text-[10px] opacity-50">{row.surveyor}</div></td><td className="px-6 py-4"><div className="text-xs">{row.survivor.kelurahan}</div><div className="text-[10px] opacity-50">RT {row.survivor.rt}/RW {row.survivor.rw}</div></td><td className="px-6 py-4"><span className={`px-2 py-1 rounded-md text-[10px] font-bold uppercase border ${row.building.kerusakan === 'rusak' ? 'bg-red-500/10 text-red-500 border-red-500/20' : 'bg-orange-500/10 text-orange-500 border-orange-500/20'}`}>{row.building.kerusakan}</span></td><td className="px-6 py-4">{row.photos ? <a href={row.photos.split('\n')[0]} target="_blank" rel="noreferrer" className="text-blue-400 hover:underline text-xs flex gap-1"><ExternalLink size={12}/> Link</a> : '-'}</td><td className="px-6 py-4 flex gap-2"><button onClick={() => onPrintPDF(row)} className="p-2 bg-slate-500/10 text-slate-400 rounded hover:bg-slate-500 hover:text-white" title="Unduh PDF"><FileDown size={16}/></button>{(currentUser.role === 'admin' || currentUser.username === row.surveyor) && (<button onClick={() => onEdit(row)} className="p-2 bg-blue-500/10 text-blue-500 rounded hover:bg-blue-500 hover:text-white"><Edit size={16}/></button>)}</td></tr>))}</tbody></table></div></div></div>);
const LoginScreen = ({ users, loading, onLogin, onFail }) => { const [u, setU] = useState(''); const [p, setP] = useState(''); const handleSubmit = (e) => { e.preventDefault(); const user = users.find(x => String(x.username).toLowerCase()===u.toLowerCase() && String(x.password)===p); if(user) onLogin(user); else onFail(); }; return (<div className="min-h-screen flex items-center justify-center bg-[#0b1120] relative overflow-hidden font-sans"><div className="absolute inset-0 bg-gradient-to-tr from-slate-900 to-[#0b1120]"></div><div className="bg-slate-900/60 backdrop-blur-xl p-8 rounded-3xl border border-white/10 shadow-2xl w-full max-w-sm relative z-10 animate-bounce-in"><div className="flex flex-col items-center mb-8"><h1 className="text-3xl font-black text-white tracking-tighter">SIJITUPASNA</h1><p className="text-blue-300 text-xs font-bold uppercase tracking-[0.3em] mt-1">Cloud Database</p></div>{loading ? <div className="text-center text-white"><Loader2 className="animate-spin w-10 h-10 mx-auto"/><p className="text-xs mt-2">Menghubungkan Database...</p></div> : <form onSubmit={handleSubmit} className="space-y-4"><input className="w-full bg-black/40 border border-white/10 text-white p-4 rounded-xl outline-none" placeholder="Username" onChange={e=>setU(e.target.value)} /><input type="password" className="w-full bg-black/40 border border-white/10 text-white p-4 rounded-xl outline-none" placeholder="Password" onChange={e=>setP(e.target.value)} /><button className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg">MASUK</button></form>}</div></div>); };
const UserManagement = ({ users, setUsers, isDark, googleScriptUrl, showToast }) => { const [form, setForm] = useState({ id: null, name: '', username: '', password: '', assignedKelurahan: '', role: 'user' }); const save = (e) => { e.preventDefault(); if(form.id) { setUsers(users.map(u => u.id === form.id ? form : u)); } else { setUsers([...users, { ...form, id: Date.now() }]); if(googleScriptUrl) { fetch(googleScriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'manage_user', user: form }) }); } } showToast("User Tersimpan (Refresh untuk permanen)", 'success'); setForm({ id: null, name: '', username: '', password: '', assignedKelurahan: '', role: 'user' }); }; return (<div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-slideIn"><div className={`p-6 rounded-2xl border h-fit ${isDark ? 'bg-white/5 border-white/10' : 'bg-white border-slate-200'}`}><h3 className="font-bold mb-4 flex items-center gap-2"><UserCog size={18}/> {form.id ? 'Edit User' : 'Tambah User'}</h3><form onSubmit={save} className="space-y-3"><input required placeholder="Nama Lengkap" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} className="w-full p-2 rounded bg-black/20 border border-white/10 outline-none text-sm text-white" /><input required placeholder="Username" value={form.username} onChange={e=>setForm({...form, username:e.target.value})} className="w-full p-2 rounded bg-black/20 border border-white/10 outline-none text-sm text-white" /><input required placeholder="Password" value={form.password} onChange={e=>setForm({...form, password:e.target.value})} className="w-full p-2 rounded bg-black/20 border border-white/10 outline-none text-sm text-white" /><input placeholder="Kunci Kelurahan" value={form.assignedKelurahan} onChange={e=>setForm({...form, assignedKelurahan:e.target.value.toUpperCase()})} className="w-full p-2 rounded bg-black/20 border border-white/10 outline-none text-sm uppercase text-white" /><button className="w-full py-2 bg-blue-600 text-white rounded font-bold text-sm">SIMPAN</button></form></div><div className="lg:col-span-2 space-y-3">{users.map(u => (<div key={u.id} className={`p-4 rounded-xl border flex justify-between items-center ${isDark ? 'bg-white/5 border-white/10' : 'bg-white border-slate-200'}`}><div><h4 className="font-bold">{u.name}</h4><p className="text-xs opacity-60">@{u.username} | {u.assignedKelurahan || 'Global'}</p></div><div className="flex gap-2"><button onClick={() => setForm(u)} className="p-2 bg-blue-500/20 text-blue-500 rounded"><UserCog size={14}/></button><button onClick={() => setUsers(users.filter(x=>x.id!==u.id))} className="p-2 bg-red-500/20 text-red-500 rounded"><Trash2 size={14}/></button></div></div>))}</div></div>); };

export default App;
